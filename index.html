<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConsistCalc - Discipline and Growth</title>
    
    <!-- Favicon Icons -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" sizes="16x16" href="icon-16x16.png">
    <link rel="icon" sizes="32x32" href="icon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon-180x180.png">
    <link rel="icon" sizes="192x192" href="icon-192x192.png">
    <link rel="icon" sizes="512x512" href="icon-512x512.png">
    <link rel="manifest" href="manifest.json">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Library untuk PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* ========================================
           DARK MODE DESIGN SYSTEM
           ======================================== */
        :root {
            /* Light Mode Colors */
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --success-light: #d1fae5;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --info: #3b82f6;
            
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --border: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-light: #9ca3af;
            
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.05);
            
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 12px;
            --space-lg: 16px;
            --space-xl: 20px;
            --space-2xl: 24px;
            
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        
        /* Dark Mode Variables */
        [data-theme="dark"] {
            --primary: #818cf8;
            --primary-dark: #6366f1;
            --success: #34d399;
            --success-light: #064e3b;
            --danger: #f87171;
            --danger-light: #7f1d1d;
            --warning: #fbbf24;
            --warning-light: #78350f;
            --info: #60a5fa;
            
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --border: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-light: #9ca3af;
            
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.3);
        }
        
        /* ========================================
           BASE STYLES
           ======================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: var(--space-lg);
            line-height: 1.5;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        [data-theme="dark"] body {
            background: linear-gradient(135deg, #4c51bf 0%, #6b21a8 100%);
        }
        
        /* ========================================
           CONTAINER
           ======================================== */
        .container {
            max-width: 1280px;
            margin: 0 auto;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            transition: background-color 0.3s ease;
            min-height: calc(100vh - 2 * var(--space-lg));
        }
        
        /* ========================================
           HEADER WITH DARK MODE TOGGLE
           ======================================== */
        .header {
            background: var(--bg-secondary);
            padding: var(--space-xl) var(--space-2xl);
            border-bottom: 1px solid var(--border);
            position: relative;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-lg);
        }
        
        .brand {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: var(--space-md);
        }
        
        .brand-icon {
            width: 40px;
            height: 40px;
            flex-shrink: 0;
        }
        
        .brand-title-group {
            display: flex;
            flex-direction: column;
        }
        
        .brand-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
            letter-spacing: -0.02em;
            transition: color 0.3s ease;
        }
        
        .brand-motto {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-style: italic;
            margin-top: var(--space-xs);
            transition: color 0.3s ease;
        }
        
        /* ========================================
           HEADER CONTROLS (Language + Dark Mode)
           ======================================== */
        .header-controls {
            display: flex;
            gap: var(--space-md);
            align-items: center;
        }
        
        .lang-selector {
            display: flex;
            gap: var(--space-sm);
            background: var(--bg-primary);
            padding: var(--space-xs);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }
        
        .lang-btn {
            padding: var(--space-sm) var(--space-md);
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
            min-width: 48px;
        }
        
        .lang-btn:hover {
            background: var(--border);
        }
        
        .lang-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            background: var(--bg-primary);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .theme-toggle:hover {
            background: var(--border);
        }
        
        .theme-toggle input {
            display: none;
        }
        
        .theme-toggle label {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            user-select: none;
        }
        
        /* ========================================
           SECTION CARDS
           ======================================== */
        .section {
            padding: var(--space-xl) var(--space-2xl);
            border-bottom: 1px solid var(--border);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .section:last-child {
            border-bottom: none;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            cursor: pointer;
            padding: var(--space-md);
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            transition: all 0.3s ease;
        }
        
        .section-header:hover {
            background: var(--border);
        }
        
        .section-title-group {
            flex: 1;
        }
        
        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: color 0.3s ease;
        }
        
        .section-subtitle {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 2px;
            transition: color 0.3s ease;
        }
        
        .section-toggle {
            width: 28px;
            height: 28px;
            border: none;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .section-toggle.collapsed {
            transform: rotate(-90deg);
        }
        
        .section-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .section-content.collapsed {
            max-height: 0;
            overflow: hidden;
        }
        
        /* ========================================
           FORM ELEMENTS
           ======================================== */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-lg);
        }
        
        .form-group {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .form-group:hover {
            border-color: var(--primary);
        }
        
        .form-group.focused {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        [data-theme="dark"] .form-group.focused {
            box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.2);
        }
        
        .form-group label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--space-md);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: color 0.3s ease;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: var(--space-md);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: all 0.3s ease;
            font-family: var(--font-family);
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .form-group input.invalid,
        .form-group select.invalid {
            border-color: var(--danger);
            background-color: var(--danger-light);
        }
        
        .form-group input.valid,
        .form-group select.valid {
            border-color: var(--success);
        }
        
        .form-group input::placeholder {
            color: var(--text-light);
        }
        
        .form-group small {
            display: block;
            margin-top: var(--space-sm);
            font-size: 0.6875rem;
            color: var(--text-light);
            transition: color 0.3s ease;
        }
        
        .form-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }
        
        .form-error {
            color: var(--danger);
            font-size: 0.75rem;
            margin-top: var(--space-sm);
            display: none;
        }
        
        /* ========================================
           BUTTONS
           ======================================== */
        .btn-group {
            display: flex;
            justify-content: center;
            gap: var(--space-md);
            margin-top: var(--space-xl);
            flex-wrap: wrap;
        }
        
        .btn {
            padding: var(--space-md) var(--space-xl);
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            font-family: var(--font-family);
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .btn:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-loading {
            position: relative;
            color: transparent !important;
        }
        
        .btn-loading::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        /* ========================================
           STATISTICS
           ======================================== */
        .stats-panel {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            transition: background-color 0.3s ease;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--space-md);
        }
        
        .stat-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            text-align: center;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .stat-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        /* Center alignment for specific stat cards */
        .stat-card.centered-values {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .stat-card.centered-values .stat-value {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }
        
        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: var(--space-xs);
            font-family: 'Courier New', monospace;
            transition: color 0.3s ease;
        }
        
        .stat-value.profit {
            color: var(--success);
        }
        
        .stat-value.loss {
            color: var(--danger);
        }
        
        .stat-value.consistency-success {
            color: var(--success);
        }
        
        .stat-value.consistency-fail {
            color: var(--danger);
        }
        
        .stat-value.profit-factor-success {
            color: var(--success);
        }
        
        .stat-value.profit-factor-fail {
            color: var(--danger);
        }
        
        .stat-label {
            font-size: 0.6875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: color 0.3s ease;
        }
        
        /* ========================================
           RISK WARNING STYLES
           ======================================== */
        .risk-warning-container {
            position: relative;
            display: inline-flex;
            align-items: center;
        }
        
        .risk-warning-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 6px;
            cursor: help;
            flex-shrink: 0;
        }
        
        .risk-warning-tooltip {
            position: absolute;
            background: var(--danger);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.7rem;
            white-space: nowrap;
            z-index: 1000;
            top: -30px;
            left: 0;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }
        
        .risk-warning-container:hover .risk-warning-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateY(-2px);
        }
        
        .risk-warning-cell {
            background: rgba(239, 68, 68, 0.08) !important;
            position: relative;
        }
        
        .high-risk-loss {
            color: var(--danger) !important;
            font-weight: 700 !important;
        }
        
        .risk-warning-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: white;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 1;
        }
        
        .day-risk-warning {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            font-weight: 600;
            font-size: 0.75rem;
            text-align: center;
            padding: 6px;
            border-left: 3px solid var(--danger);
            margin-bottom: 4px;
        }
        
        /* ========================================
           TRADING HISTORY
           ======================================== */
        .history-container {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .history-scroll {
            overflow-x: auto;
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
            min-width: 600px;
        }
        
        .history-table th {
            background: var(--bg-secondary);
            padding: var(--space-md);
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s ease;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .history-table td {
            padding: var(--space-md);
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        .history-table tbody tr:hover {
            background: var(--bg-primary);
        }
        
        .history-table .profit {
            color: var(--success);
            font-weight: 600;
        }
        
        .history-table .loss {
            color: var(--danger);
            font-weight: 600;
        }
        
        /* ========================================
           ALERTS & TOAST
           ======================================== */
        .alerts-container {
            margin-bottom: var(--space-lg);
        }
        
        .alert-banner {
            padding: var(--space-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-sm);
            font-size: 0.75rem;
            font-weight: 500;
            border-left: 3px solid;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .alert-banner.success {
            background: var(--success-light);
            color: var(--success);
            border-left-color: var(--success);
        }
        
        .alert-banner.error {
            background: var(--danger-light);
            color: var(--danger);
            border-left-color: var(--danger);
        }
        
        .alert-banner.warning {
            background: var(--warning-light);
            color: var(--warning);
            border-left-color: var(--warning);
        }
        
        .alert-banner.info {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info);
            border-left-color: var(--info);
        }
        
        /* Dark mode alert text color */
        [data-theme="dark"] .alert-banner.success,
        [data-theme="dark"] .alert-banner.error,
        [data-theme="dark"] .alert-banner.warning,
        [data-theme="dark"] .alert-banner.info {
            color: #ffffff;
        }
        
        .alert-banner.risk {
            background: var(--danger-light);
            color: var(--danger);
            border-left-color: var(--danger);
            border-left-width: 4px;
        }
        
        .alert-banner.risk::before {
            content: "⚠️";
            margin-right: var(--space-sm);
            font-size: 1rem;
        }
        
        .toast-container {
            position: fixed;
            top: var(--space-lg);
            right: var(--space-lg);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }
        
        .toast {
            padding: var(--space-md) var(--space-lg);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            border-left: 3px solid;
            font-size: 0.75rem;
            animation: slideInRight 0.3s ease;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--space-md);
            max-width: 350px;
        }
        
        .toast.success {
            border-left-color: var(--success);
        }
        
        .toast.error {
            border-left-color: var(--danger);
        }
        
        .toast.warning {
            border-left-color: var(--warning);
        }
        
        .toast.info {
            border-left-color: var(--info);
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .toast-message {
            font-size: 0.7rem;
        }
        
        .toast-close {
            border: none;
            background: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: var(--space-xs);
            font-size: 0.875rem;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .toast-close:hover {
            opacity: 1;
        }
        
        /* ========================================
           EXPORT SECTION
           ======================================== */
        .export-section {
            padding: var(--space-xl) var(--space-2xl);
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
            transition: all 0.3s ease;
            text-align: center;
        }
        
        /* ========================================
           PRINT STYLES (A4 Report)
           ======================================== */
        @media print {
            body {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            body * {
                visibility: hidden;
            }
            
            .print-report, .print-report * {
                visibility: visible;
            }
            
            .print-report {
                position: absolute;
                left: 0;
                top: 0;
                width: 210mm;
                padding: 20mm;
                margin: 0;
            }
            
            @page {
                size: A4;
                margin: 20mm;
            }
        }
        
        /* ========================================
           FOOTER
           ======================================== */
        .footer {
            text-align: center;
            padding: var(--space-lg);
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
            font-size: 0.75rem;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }
        
        /* ========================================
           RESPONSIVE DESIGN
           ======================================== */
        @media (max-width: 768px) {
            body {
                padding: var(--space-md);
            }
            
            .header {
                padding: var(--space-lg);
            }
            
            .header-content {
                flex-direction: column;
                align-items: stretch;
            }
            
            .header-controls {
                justify-content: center;
            }
            
            .section {
                padding: var(--space-lg);
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .toast-container {
                left: var(--space-md);
                right: var(--space-md);
                top: var(--space-md);
            }
            
            .toast {
                max-width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .header-controls {
                flex-direction: column;
                gap: var(--space-sm);
            }
            
            .lang-selector,
            .theme-toggle {
                width: 100%;
                justify-content: center;
            }
            
            .history-table {
                font-size: 0.7rem;
            }
            
            .history-table th,
            .history-table td {
                padding: var(--space-sm);
            }
        }
        
        /* ========================================
           ANIMATIONS
           ======================================== */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 1;
            }
            20% {
                transform: scale(25, 25);
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: scale(40, 40);
            }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* ========================================
           LOADING OVERLAY
           ======================================== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: white;
            font-size: 1rem;
            flex-direction: column;
            gap: var(--space-lg);
            animation: fadeIn 0.3s ease;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        .loading-text {
            font-size: 1rem;
            font-weight: 500;
        }
        
        /* ========================================
           TOOLTIPS
           ======================================== */
        [data-tooltip] {
            position: relative;
        }
        
        [data-tooltip]:before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            z-index: 1000;
            pointer-events: none;
        }
        
        [data-tooltip]:hover:before {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-5px);
        }
        
        /* ========================================
           EMPTY STATES
           ======================================== */
        .empty-state {
            text-align: center;
            padding: var(--space-2xl) var(--space-xl);
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: var(--space-lg);
            opacity: 0.5;
        }
        
        .empty-state-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: var(--space-sm);
        }
        
        .empty-state-description {
            font-size: 0.875rem;
            max-width: 400px;
            margin: 0 auto;
        }
        
        /* ========================================
           MAX DAILY PROFIT LIMIT BOX (DATABASE)
           ======================================== */
        .daily-limit-box {
            background: var(--bg-primary);
            border: 2px solid var(--primary);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            margin-top: var(--space-xl);
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .daily-limit-box-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--space-xs);
            transition: color 0.3s ease;
        }
        
        .daily-limit-box-value {
            font-family: 'Courier New', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            transition: color 0.3s ease;
        }
        
        .daily-limit-box-note {
            font-size: 0.6875rem;
            color: var(--text-light);
            margin-top: var(--space-xs);
            transition: color 0.3s ease;
        }
        
        /* ========================================
           DAILY LIMIT STATUS (STATISTICS)
           ======================================== */
        .daily-limit-status {
            font-size: 0.6875rem;
            color: var(--text-light);
            margin-top: var(--space-xs);
            font-style: italic;
            transition: color 0.3s ease;
        }
        
        .daily-limit-status.safe {
            color: var(--success);
        }
        
        .daily-limit-status.warning {
            color: var(--warning);
        }
        
        /* Daily Loss Card */
        .stat-card.daily-loss-card {
            border-left: 3px solid var(--danger);
        }
        
        .stat-card.daily-loss-card .stat-value {
            color: var(--danger);
        }
        
        .stat-card.daily-loss-card .progress-mini .progress-fill {
            background: var(--danger);
        }
        
        .stat-card.daily-loss-card .progress-mini .progress-fill.warning {
            background: var(--warning);
        }
        
        .stat-card.daily-loss-card .progress-mini .progress-fill.danger {
            background: var(--danger);
        }
        
        .stat-subinfo {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        .progress-mini {
            height: 6px;
            background: var(--bg-primary);
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .progress-mini .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .stat-subtext {
            font-size: 0.625rem;
            color: var(--text-light);
            margin-top: 4px;
            font-style: italic;
        }
        
        /* Max Loss Card */
        .stat-card.max-loss-card {
            border-left: 3px solid var(--warning);
        }
        
        .stat-card.max-loss-card .stat-value {
            color: var(--warning);
        }
        
        .stat-card.max-loss-card .progress-mini .progress-fill {
            background: var(--warning);
        }
        
        .stat-card.max-loss-card .progress-mini .progress-fill.danger {
            background: var(--danger);
        }
        
        .daily-limit-status.danger {
            color: var(--danger);
        }
        
        /* ========================================
           DAILY LIMIT HINT (TRADING INPUT)
           ======================================== */
        .daily-limit-hint {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: var(--space-sm);
            text-align: center;
            font-family: 'Courier New', monospace;
            transition: color 0.3s ease;
        }
        
        /* ========================================
           MOTIVATIONAL MESSAGES
           ======================================== */
        .motivational-message {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: center;
            margin-top: var(--space-sm);
            font-style: italic;
            padding: var(--space-sm);
            border-radius: var(--radius-sm);
            transition: all 0.3s ease;
        }
        
        .motivational-message.safe {
            background: var(--success-light);
            color: var(--success);
        }
        
        .motivational-message.warning {
            background: var(--warning-light);
            color: var(--warning);
        }
        
        .motivational-message.danger {
            background: var(--danger-light);
            color: var(--danger);
        }
        
        .motivational-message.info {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info);
        }
        
        .motivational-message.milestone {
            background: var(--primary);
            color: white;
        }
        
        .stat-card-message {
            font-size: 0.6875rem;
            color: var(--text-secondary);
            margin-top: var(--space-xs);
            font-style: italic;
            text-align: center;
        }
        
        .history-header-message {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: center;
            font-style: italic;
            margin-bottom: var(--space-md);
            padding: var(--space-sm);
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
        }
        
        .footer-quote {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: var(--space-sm);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Toast Container -->
        <div class="toast-container" id="toast-container"></div>
        
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loading-overlay" style="display: none;">
            <div class="loading-spinner"></div>
            <div class="loading-text">Generating PDF Report...</div>
        </div>
        
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="brand">
                    <img src="icon-192x192.png" alt="ConsistCalc Logo" class="brand-icon">
                    <div class="brand-title-group">
                        <h1 class="brand-title" data-i18n="appTitle">ConsistCalc</h1>
                        <p class="brand-motto" data-i18n="motto">Discipline and Growth</p>
                    </div>
                </div>
                
                <!-- Header Controls -->
                <div class="header-controls">
                    <!-- Language Selector -->
                    <div class="lang-selector">
                        <button class="lang-btn active" data-lang="id" title="Bahasa Indonesia" aria-label="Switch to Indonesian">
                            <span>ID</span>
                        </button>
                        <button class="lang-btn" data-lang="en" title="English" aria-label="Switch to English">
                            <span>EN</span>
                        </button>
                    </div>
                    
                    <!-- Dark Mode Toggle -->
                    <div class="theme-toggle" id="theme-toggle" role="button" aria-pressed="false" tabindex="0" aria-label="Toggle dark mode">
                        <input type="checkbox" id="dark-mode-switch">
                        <label for="dark-mode-switch">
                            <span id="theme-text">Dark Mode</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Database Section -->
        <div class="section setup-section">
            <div class="section-header" onclick="toggleSection('setup-content', 'setup-toggle')" role="button" aria-expanded="true" tabindex="0">
                <div class="section-title-group">
                    <h2 class="section-title" data-i18n="database">DATABASE</h2>
                    <p class="section-subtitle" data-i18n="databaseSubtitle">Configure your trading parameters and risk management settings</p>
                </div>
                <button class="section-toggle" id="setup-toggle" aria-label="Collapse section">▼</button>
            </div>
            <div class="section-content" id="setup-content">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="currency" data-i18n="currency">Currency</label>
                        <select id="currency" onchange="updateCurrencySymbol()" data-tooltip="Select your trading currency">
                            <option value="USD" data-symbol="$">USD ($)</option>
                            <option value="IDR" data-symbol="Rp">IDR (Rp)</option>
                            <option value="EUR" data-symbol="€">EUR (€)</option>
                            <option value="GBP" data-symbol="£">GBP (£)</option>
                            <option value="JPY" data-symbol="¥">JPY (¥)</option>
                            <option value="CAD" data-symbol="C$">CAD (C$)</option>
                            <option value="AUD" data-symbol="A$">AUD (A$)</option>
                            <option value="CNY" data-symbol="¥">CNY (¥)</option>
                            <option value="SGD" data-symbol="S$">SGD (S$)</option>
                            <option value="MYR" data-symbol="RM">MYR (RM)</option>
                            <option value="THB" data-symbol="฿">THB (฿)</option>
                            <option value="KRW" data-symbol="₩">KRW (₩)</option>
                            <option value="INR" data-symbol="₹">INR (₹)</option>
                            <option value="CHF" data-symbol="CHF">CHF (CHF)</option>
                            <option value="NZD" data-symbol="NZ$">NZD (NZ$)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="account-balance" data-i18n="accountBalance">Account Balance</label>
                        <input type="number" id="account-balance" step="0.01" placeholder="e.g. 1000" 
                               data-i18n-placeholder="accountBalancePlaceholder" min="0" data-tooltip="Your initial account balance">
                        <div class="form-error" id="account-balance-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="target-percent" data-i18n="targetPercent">Target %</label>
                        <input type="number" id="target-percent" step="0.01" placeholder="e.g. 8" 
                               data-i18n-placeholder="targetPercentPlaceholder" min="0" max="100" data-tooltip="Monthly profit target percentage">
                        <div class="form-error" id="target-percent-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="max-loss-percent" data-i18n="maxLossPercent">Max Loss % (total)</label>
                        <input type="number" id="max-loss-percent" step="0.01" placeholder="e.g. 5" 
                               data-i18n-placeholder="maxLossPercentPlaceholder" min="0" max="100" data-tooltip="Maximum total loss percentage allowed">
                        <div class="form-error" id="max-loss-percent-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="daily-loss-percent" data-i18n="dailyLossPercent">Daily Loss %</label>
                        <input type="number" id="daily-loss-percent" step="0.01" placeholder="e.g. 2" 
                               data-i18n-placeholder="dailyLossPercentPlaceholder" min="0" max="100" data-tooltip="Maximum daily loss percentage allowed">
                        <div class="form-error" id="daily-loss-percent-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="risk-trading-percent" data-i18n="riskTradingPercent">Risk Trading %</label>
                        <input type="number" id="risk-trading-percent" step="0.01" placeholder="e.g. 1 (per trade)" 
                               data-i18n-placeholder="riskTradingPercentPlaceholder" min="0" max="100" data-tooltip="Maximum risk per individual trade">
                        <small data-i18n="riskTradingNote">Warning shown if single loss > this % of account balance</small>
                        <div class="form-error" id="risk-trading-percent-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="consistency-percent" data-i18n="consistencyRule">Consistency Rule %</label>
                        <input type="number" id="consistency-percent" step="0.01" placeholder="e.g. 20" 
                               data-i18n-placeholder="consistencyRulePlaceholder" min="0" max="100" data-tooltip="Max daily profit % of total net profit (profit - loss)">
                        <small data-i18n="consistencyNote">Max daily profit (highest positive) / total net profit × 100</small>
                        <div class="form-error" id="consistency-percent-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="min-trading-days" data-i18n="minTradingDays">Min Trading Days</label>
                        <div style="display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-sm);">
                            <input type="checkbox" id="min-trading-days-enabled" style="width: auto;">
                            <span style="font-size: 0.75rem; color: var(--text-secondary);" data-i18n="minTradingDaysEnabled">Enable minimum trading days rule</span>
                        </div>
                        <input type="number" id="min-trading-days" step="1" placeholder="e.g. 3" 
                               data-i18n-placeholder="minTradingDaysPlaceholder" min="1" data-tooltip="Minimum trading days required before consistency check applies">
                        <small data-i18n="minTradingDaysNote">Consistency check only applies after reaching this number of trading days</small>
                        <div class="form-error" id="min-trading-days-error"></div>
                    </div>
                </div>
                
                <!-- Max Daily Profit Limit Info Box -->
                <div class="daily-limit-box" id="daily-limit-box">
                    <div class="daily-limit-box-label" data-i18n="maxDailyLimitLabel">Max Daily Profit Limit</div>
                    <div class="daily-limit-box-value" id="daily-limit-value">$0.00</div>
                    <div class="daily-limit-box-note" data-i18n="maxDailyLimitNote">Based on your target and consistency settings</div>
                    <div class="motivational-message" id="db-motivational-msg" data-i18n="msgSafe">Konsistensi Anda aman! Terus pertahankan posisi yang terkendali.</div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="saveSetup()" id="save-setup-btn" data-tooltip="Save all settings">
                        <span data-i18n="save">SAVE</span>
                    </button>
                    <button class="btn btn-danger" onclick="resetAll()" data-tooltip="Reset all data and settings">
                        <span data-i18n="resetAll">RESET ALL</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Trading Input Section -->
        <div class="section trading-section">
            <div class="section-header" onclick="toggleSection('trading-content', 'trading-toggle')" role="button" aria-expanded="true" tabindex="0">
                <div class="section-title-group">
                    <h2 class="section-title" data-i18n="tradingInput">TRADING RESULTS INPUT</h2>
                    <p class="section-subtitle" data-i18n="tradingSubtitle">Enter your daily profit or loss entries</p>
                </div>
                <button class="section-toggle" id="trading-toggle" aria-label="Collapse section">▼</button>
            </div>
            <div class="section-content" id="trading-content">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="profit" data-i18n="profit">Profit</label>
                        <input type="number" id="profit" step="0.01" placeholder="e.g. 25" 
                               data-i18n-placeholder="profitPlaceholder" min="0" onkeydown="handleTradeKeyPress(event)"
                               data-tooltip="Enter profit amount (positive number)">
                        <div class="form-error" id="profit-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="loss" data-i18n="loss">Loss</label>
                        <input type="number" id="loss" step="0.01" placeholder="e.g. 10" 
                               data-i18n-placeholder="lossPlaceholder" min="0" onkeydown="handleTradeKeyPress(event)"
                               data-tooltip="Enter loss amount (positive number)">
                        <div class="form-error" id="loss-error"></div>
                    </div>
                </div>
                <p class="daily-limit-hint" id="daily-limit-hint">Max safe today: $0.00</p>
                <p style="text-align: center; margin: var(--space-lg) 0; color: var(--text-secondary); font-size: 0.875rem;" data-i18n="tradeNote">Enter either Profit or Loss (not both)</p>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="addTrade()" id="add-trade-btn" data-tooltip="Add this trade to history">
                        <span data-i18n="add">ADD</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Statistics Section -->
        <div class="section stats-section">
            <div class="section-header" onclick="toggleSection('stats-content', 'stats-toggle')" role="button" aria-expanded="true" tabindex="0">
                <div class="section-title-group">
                    <h2 class="section-title" data-i18n="statistics">STATISTICS</h2>
                    <p class="section-subtitle" data-i18n="statisticsSubtitle">Real-time performance metrics and analysis</p>
                </div>
                <button class="section-toggle" id="stats-toggle" aria-label="Collapse section">▼</button>
            </div>
            <div class="section-content" id="stats-content">
                <!-- Alert Banners -->
                <div class="alerts-container" id="alerts-container"></div>
                <div class="stats-panel">
                    <div class="stats-grid">
                        <div class="stat-card highlight">
                            <div class="stat-value" id="total-balance">$0.00</div>
                            <div class="stat-label" data-i18n="totalBalance">Total Balance</div>
                        </div>
                        <div class="stat-card profit">
                            <div class="stat-value profit" id="total-profit">$0.00</div>
                            <div class="stat-label" data-i18n="totalProfit">Total Profit</div>
                        </div>
                        <div class="stat-card loss">
                            <div class="stat-value loss" id="total-loss">$0.00</div>
                            <div class="stat-label" data-i18n="totalLoss">Total Loss</div>
                        </div>
                        <div class="stat-card net">
                            <div class="stat-value" id="net-profit">$0.00</div>
                            <div class="stat-label" data-i18n="netProfit">Net Profit</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-value" id="progress-target">0%</div>
                            <div class="stat-label" data-i18n="progressTarget">Progress Target</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="profit-factor">-</div>
                            <div class="stat-label" data-i18n="profitFactor">Profit Factor</div>
                        </div>
                        <div class="stat-card centered-values">
                            <div class="stat-value" id="consistency-rule">-</div>
                            <div class="stat-label" data-i18n="consistency">Consistency</div>
                        </div>
                        <div class="stat-card centered-values">
                            <div class="stat-value" id="total-trading">0</div>
                            <div class="stat-label" data-i18n="totalTrading">Total Trading</div>
                        </div>
                        <!-- Daily Loss Card (Fixed, resets daily) -->
                        <div class="stat-card daily-loss-card">
                            <div class="stat-value" id="daily-loss-limit-stat">$0.00</div>
                            <div class="stat-label" data-i18n="dailyLossLimit">Daily Loss Limit</div>
                            <div class="stat-subinfo" id="daily-loss-subinfo">0% used</div>
                            <div class="progress-mini">
                                <div class="progress-fill" id="daily-loss-progress-fill" style="width: 0%"></div>
                            </div>
                            <div class="stat-subtext" data-i18n="fixedFromOpening">Fixed from opening balance</div>
                        </div>
                        <!-- Max Loss Card (Floating, follows balance) -->
                        <div class="stat-card max-loss-card">
                            <div class="stat-value" id="max-loss-limit-stat">$0.00</div>
                            <div class="stat-label" data-i18n="maxLossLimit">Max Loss Limit</div>
                            <div class="stat-subinfo" id="max-loss-subinfo">0% used</div>
                            <div class="progress-mini">
                                <div class="progress-fill" id="max-loss-progress-fill" style="width: 0%"></div>
                            </div>
                            <div class="stat-subtext" data-i18n="floatingFromBalance">Floating from current balance</div>
                        </div>
                        <div class="stat-card daily-limit">
                            <div class="stat-value" id="daily-limit-stat">$0.00</div>
                            <div class="stat-label" data-i18n="maxDailyLimit">Max Daily Limit</div>
                            <div class="daily-limit-status" id="daily-limit-status" data-i18n="maxDailyLimitStatus">Consistency safe if profit ≤ limit</div>
                            <div class="stat-card-message" id="stats-motivational-msg" data-i18n="msgSafe">Konsistensi Anda aman!</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Trading History Section -->
        <div class="section display-section">
            <div class="section-header" onclick="toggleSection('history-content', 'history-toggle')" role="button" aria-expanded="true" tabindex="0">
                <div class="section-title-group">
                    <h2 class="section-title" data-i18n="tradingHistory">TRADING HISTORY</h2>
                    <p class="section-subtitle" data-i18n="historySubtitle">Daily trading records and performance summary</p>
                </div>
                <button class="section-toggle" id="history-toggle" aria-label="Collapse section">▼</button>
            </div>
            <div class="section-content" id="history-content">
                <div class="history-header-message" id="history-motivational-msg" data-i18n="msgHistoryHeader">
                    Setiap trade adalah kesempatan untuk belajar. Konsistensi kecil membawa keberhasilan besar.
                </div>
                <div class="history-container" id="history-container">
                    <div class="history-scroll">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th data-i18n="day">Day</th>
                                    <th data-i18n="openPos">Open Pos</th>
                                    <th data-i18n="profit">Profit</th>
                                    <th data-i18n="loss">Loss</th>
                                    <th data-i18n="dailyNet">Daily Net</th>
                                    <th data-i18n="peak">Peak</th>
                                    <th data-i18n="action">Action</th>
                                </tr>
                            </thead>
                            <tbody id="history-tbody">
                                <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Export Section -->
        <div class="export-section">
            <button class="btn btn-warning" onclick="generatePDFReport()" id="pdf-btn" data-tooltip="Generate and download PDF report">
                <span>SAVE AS PDF</span>
            </button>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <p class="footer-quote" data-i18n="footerQuote">Disiplin adalah jembatan antara tujuan dan hasil.</p>
            <p class="footer-text">Licensed under MIT License, Copyright © 2025 Created by Xamn</p>
        </div>
    </div>
    
    <!-- JavaScript dengan Perbaikan Lengkap -->
    <script>
        // ========================================
        // CONSTANTS & CONFIGURATION
        // ========================================
        const APP_NAME = 'ConsistCalc';
        const APP_VERSION = '2.3';
        const SYDNEY_OPEN_HOUR = 7; // 07:00 Sydney (AEDT/AEST) for Trading Day Start
        const SYDNEY_TIMEZONE = 'Australia/Sydney';
        
        // ========================================
        // TRANSLATION SYSTEM
        // ========================================
        const translations = {
            id: {
                appTitle: "ConsistCalc",
                motto: "Disiplin dan Pertumbuhan",
                database: "DATABASE",
                databaseSubtitle: "Konfigurasi parameter trading dan pengaturan manajemen risiko",
                tradingInput: "MASUKAN HASIL PERDAGANGAN",
                tradingSubtitle: "Masukkan entri profit atau loss harian Anda",
                statistics: "STATISTIK",
                statisticsSubtitle: "Metrik kinerja real-time dan analisis",
                tradingHistory: "RIWAYAT TRADING",
                historySubtitle: "Catatan trading harian dan ringkasan performa",
                currency: "Mata Uang",
                accountBalance: "Saldo Akun",
                accountBalancePlaceholder: "misal: 1000",
                targetPercent: "Target %",
                targetPercentPlaceholder: "misal: 8",
                maxLossPercent: "Max Loss % (total)",
                maxLossPercentPlaceholder: "misal: 5",
                dailyLossPercent: "Max Loss Harian %",
                dailyLossPercentPlaceholder: "misal: 2",
                riskTradingPercent: "Risk per Trade %",
                riskTradingPercentPlaceholder: "misal: 1",
                riskTradingNote: "Peringatan muncul jika loss > % ini dari saldo",
                consistencyRule: "Aturan Konsistensi %",
                consistencyRulePlaceholder: "misal: 50",
                consistencyNote: "Profit harian maks (positif tertinggi) / total net profit × 100",
                maxDailyLimitLabel: "Batas Maksimal Profit Harian",
                maxDailyLimitNote: "Berdasarkan target dan aturan konsistensi Anda",
                maxDailyLimit: "Batas Harian",
                maxDailyLimitHint: "Batas aman hari ini",
                maxDailyLimitStatus: "Konsistensi aman jika profit ≤ batas",
                // Motivational Messages
                msgSafe: "Konsistensi Anda aman! Terus pertahankan posisi yang terkendali. Ingat: konsistensi yang baik adalah kunci sukses dalam trading.",
                msgWarning: "Konsistensi Anda mulai mendekati batas. Tarik napas, evaluasi, dan lanjutkan dengan posisi yang lebih terkontrol.",
                msgDanger: "Konsistensi Anda melampaui batas. Ini kesempatan untuk belajar. Setiap trader besar pernah di posisi ini. Evaluasi dan kembali ke jalur benar.",
                msgTargetAchieved: "Target tercapai! Perolehan yang membanggakan. Tapi perjalanan masih berlanjut. Trading tetap bijak dan disiplin ya.",
                msgDayOne: "Setiap perjalanan trading yang sukses dimulai dengan langkah pertama. Fokus pada proses, bukan hasil. Konsistensi akan membawa Anda ke tujuan.",
                msgHistoryHeader: "Setiap trade adalah kesempatan untuk belajar. Konsistensi kecil membawa keberhasilan besar.",
                msgTradeAdded: "Trade berhasil ditambahkan. Lanjutkan trading yang bijak!",
                msgSaveSetup: "Pengaturan berhasil disimpan. Trading dengan bijak ya!",
                footerQuote: "Disiplin adalah jembatan antara tujuan dan hasil.",
                totalTrading: "Total Trading",
                save: "SIMPAN",
                resetAll: "RESET SEMUA",
                // New Risk Cards
                dailyLossLimit: "Batas Loss Harian",
                maxLossLimit: "Batas Max Loss",
                fixedFromOpening: "Tetap dari saldo pembukaan",
                floatingFromBalance: "Mengambang dari saldo berjalan",
                usedFormat: "{percent}% terpakai",
                profit: "Profit",
                profitPlaceholder: "misal: 25",
                loss: "Loss",
                lossPlaceholder: "misal: 10",
                tradeNote: "Masukkan hanya profit ATAU loss (bukan keduanya)",
                add: "TAMBAH",
                exportData: "EKSPOR DATA",
                totalBalance: "Total Saldo",
                totalProfit: "Total Profit",
                totalLoss: "Total Loss",
                netProfit: "Net Profit",
                progressTarget: "Progres Target",
                profitFactor: "Faktor Profit",
                consistency: "Konsistensi",
                noProfit: "BELUM ADA PROFIT",
                consistencyStatus: "Status",
                day: "Hari",
                openPos: "Open Pos",
                dailyNet: "Net Harian",
                peak: "Peak",
                action: "Aksi",
                noData: "Belum ada data trading",
                deleteConfirm: "Hapus trade ini?",
                resetAllConfirm: "Anda yakin ingin mereset semua data?",
                success: "Berhasil!",
                error: "Error!",
                warning: "Peringatan!",
                info: "Info",
                riskExceeded: "RISK TERLAMPAUI! Loss melebihi",
                highRiskTrade: "TRADE RISK TINGGI",
                riskWarningDesc: "Loss ini melebihi batas risk trading yang ditetapkan",
                riskWarning: "Melebihi risk per trade!",
                dailyLossExceeded: "Loss harian melebihi batas!",
                totalLossExceeded: "Total loss mencapai maksimum!",
                passedChallenge: "Selamat! Anda lulus tantangan!",
                consistencyMet: "Konsistensi terpenuhi!",
                consistencyNotMet: "Konsistensi tidak terpenuhi!",
                minTradingDays: "Min Hari Trading",
                minTradingDaysEnabled: "Aktifkan aturan minimum hari trading",
                minTradingDaysPlaceholder: "misal: 3",
                minTradingDaysNote: "Konsistensi dicek setelah mencapai jumlah hari trading ini",
                minDaysNotMet: "Belum mencapai minimum hari trading!",
                daysRemaining: "Sisa hari:",
                targetAchieved: "Target tercapai!",
                progressToTarget: "Progres ke target:",
                invalidInput: "Input tidak valid",
                requiredField: "Field ini wajib diisi",
                loading: "Memuat...",
                saving: "Menyimpan...",
                generatingPDF: "Membuat PDF...",
                noTrades: "Belum ada data trading untuk diekspor",
                exportSuccess: "Data berhasil diekspor",
                importSuccess: "Data berhasil diimpor",
                invalidFile: "File tidak valid",
                backupCreated: "Backup berhasil dibuat",
                backupRestored: "Backup berhasil dipulihkan",
                darkMode: "Dark Mode",
                lightMode: "Light Mode"
            },
            en: {
                appTitle: "ConsistCalc",
                motto: "Discipline and Growth",
                database: "DATABASE",
                databaseSubtitle: "Configure your trading parameters and risk management settings",
                tradingInput: "TRADING RESULTS INPUT",
                tradingSubtitle: "Enter your daily profit or loss entries",
                statistics: "STATISTICS",
                statisticsSubtitle: "Real-time performance metrics and analysis",
                tradingHistory: "TRADING HISTORY",
                historySubtitle: "Daily trading records and performance summary",
                currency: "Currency",
                accountBalance: "Account Balance",
                accountBalancePlaceholder: "e.g. 1000",
                targetPercent: "Target %",
                targetPercentPlaceholder: "e.g. 8",
                maxLossPercent: "Max Loss % (total)",
                maxLossPercentPlaceholder: "e.g. 5",
                dailyLossPercent: "Daily Loss %",
                dailyLossPercentPlaceholder: "e.g. 2",
                riskTradingPercent: "Risk Trading %",
                riskTradingPercentPlaceholder: "e.g. 1",
                riskTradingNote: "Warning shown if single loss > this % of account balance",
                consistencyRule: "Consistency Rule %",
                consistencyRulePlaceholder: "e.g. 50",
                consistencyNote: "Max daily profit (highest positive) / total net profit × 100",
                maxDailyLimitLabel: "Max Daily Profit Limit",
                maxDailyLimitNote: "Based on your target and consistency settings",
                maxDailyLimit: "Daily Limit",
                maxDailyLimitHint: "Safe limit today",
                maxDailyLimitStatus: "Consistency safe if profit ≤ limit",
                // Motivational Messages
                msgSafe: "Your consistency is safe! Keep maintaining controlled positions. Remember: good consistency is the key to trading success.",
                msgWarning: "Your consistency is approaching the limit. Take a breath, evaluate, and continue with more controlled positions.",
                msgDanger: "Your consistency exceeded the limit. This is a learning opportunity. Every great trader has been here. Evaluate and get back on track.",
                msgTargetAchieved: "Target achieved! A remarkable achievement. But the journey continues. Trade wisely and stay disciplined.",
                msgDayOne: "Every successful trading journey starts with the first step. Focus on the process, not the result. Consistency will bring you to your goal.",
                msgHistoryHeader: "Every trade is a learning opportunity. Small consistency leads to big success.",
                msgTradeAdded: "Trade added successfully. Continue trading wisely!",
                msgSaveSetup: "Settings saved successfully. Trade wisely!",
                footerQuote: "Discipline is the bridge between goals and results.",
                totalTrading: "Total Trading",
                save: "SAVE",
                resetAll: "RESET ALL",
                // New Risk Cards
                dailyLossLimit: "Daily Loss Limit",
                maxLossLimit: "Max Loss Limit",
                fixedFromOpening: "Fixed from opening balance",
                floatingFromBalance: "Floating from current balance",
                usedFormat: "{percent}% used",
                profit: "Profit",
                profitPlaceholder: "e.g. 25",
                loss: "Loss",
                lossPlaceholder: "e.g. 10",
                tradeNote: "Enter either Profit or Loss (not both)",
                add: "ADD",
                exportData: "EXPORT DATA",
                totalBalance: "Total Balance",
                totalProfit: "Total Profit",
                totalLoss: "Total Loss",
                netProfit: "Net Profit",
                progressTarget: "Progress Target",
                profitFactor: "Profit Factor",
                consistency: "Consistency",
                noProfit: "NO PROFIT YET",
                consistencyStatus: "Status",
                day: "Day",
                openPos: "Open Pos",
                dailyNet: "Daily Net",
                peak: "Peak",
                action: "Action",
                noData: "No trading data available",
                deleteConfirm: "Delete this trade?",
                resetAllConfirm: "Are you sure you want to reset all data?",
                success: "Success!",
                error: "Error!",
                warning: "Warning!",
                info: "Info",
                riskExceeded: "RISK EXCEEDED! Loss exceeds",
                highRiskTrade: "HIGH RISK TRADE",
                riskWarningDesc: "This loss exceeds the set risk trading limit",
                riskWarning: "Risk per trade exceeded!",
                dailyLossExceeded: "Daily loss exceeds limit!",
                totalLossExceeded: "Total loss reached maximum!",
                passedChallenge: "Congratulations! You passed the challenge!",
                consistencyMet: "Consistency met!",
                consistencyNotMet: "Consistency not met!",
                minTradingDays: "Min Trading Days",
                minTradingDaysEnabled: "Enable minimum trading days rule",
                minTradingDaysPlaceholder: "e.g. 3",
                minTradingDaysNote: "Consistency check only applies after reaching this number of trading days",
                minDaysNotMet: "Minimum trading days not met!",
                daysRemaining: "Days remaining:",
                targetAchieved: "Target achieved!",
                progressToTarget: "Progress to target:",
                invalidInput: "Invalid input",
                requiredField: "This field is required",
                loading: "Loading...",
                saving: "Saving...",
                generatingPDF: "Generating PDF...",
                noTrades: "No trading data to export",
                exportSuccess: "Data exported successfully",
                importSuccess: "Data imported successfully",
                invalidFile: "Invalid file",
                backupCreated: "Backup created successfully",
                backupRestored: "Backup restored successfully",
                darkMode: "Dark Mode",
                lightMode: "Light Mode"
            }
        };

        let currentLang = localStorage.getItem('consistcalc-lang') || 'id';

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        function formatNumber(num, decimals = 2) {
            return num.toLocaleString(undefined, {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }

        function formatCurrency(amount, symbol = '$', decimals = 2) {
            const formatted = formatNumber(Math.abs(amount), decimals);
            const sign = amount >= 0 ? '' : '-';
            return `${sign}${symbol}${formatted}`;
        }

        function showLoading(show, message = null) {
            const overlay = document.getElementById('loading-overlay');
            if (!overlay) return;
            
            if (show) {
                if (message) {
                    overlay.querySelector('.loading-text').textContent = message;
                }
                overlay.style.display = 'flex';
            } else {
                overlay.style.display = 'none';
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ========================================
        // TOAST SYSTEM
        // ========================================
        class Toast {
            static show(message, type = 'info', duration = 3000) {
                const container = document.getElementById('toast-container');
                if (!container) return;
                
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.setAttribute('role', 'alert');
                toast.setAttribute('aria-live', 'assertive');
                toast.setAttribute('aria-atomic', 'true');
                
                const title = translations[currentLang][type] || type.charAt(0).toUpperCase() + type.slice(1);
                
                toast.innerHTML = `
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close" aria-label="Close notification" onclick="this.parentElement.remove()">
                        &times;
                    </button>
                `;
                
                container.appendChild(toast);
                
                // Auto-remove after duration
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.style.animation = 'slideOutRight 0.3s ease';
                        setTimeout(() => toast.remove(), 300);
                    }
                }, duration);
            }
            
            static success(message) { this.show(message, 'success'); }
            static error(message) { this.show(message, 'error'); }
            static warning(message) { this.show(message, 'warning'); }
            static info(message) { this.show(message, 'info'); }
        }

        // ========================================
        // VALIDATION SYSTEM
        // ========================================
        class Validator {
            static validateSetup(setup) {
                const errors = {};
                
                if (!setup.accountBalance || setup.accountBalance <= 0) {
                    errors.accountBalance = translations[currentLang].requiredField;
                }
                
                if (!setup.targetPercent || setup.targetPercent <= 0 || setup.targetPercent > 100) {
                    errors.targetPercent = translations[currentLang].invalidInput;
                }
                
                if (!setup.maxLossPercent || setup.maxLossPercent <= 0 || setup.maxLossPercent > 100) {
                    errors.maxLossPercent = translations[currentLang].invalidInput;
                }
                
                if (!setup.dailyLossPercent || setup.dailyLossPercent <= 0 || setup.dailyLossPercent > 100) {
                    errors.dailyLossPercent = translations[currentLang].invalidInput;
                }
                
                if (!setup.riskTradingPercent || setup.riskTradingPercent <= 0 || setup.riskTradingPercent > 100) {
                    errors.riskTradingPercent = translations[currentLang].invalidInput;
                }
                
                if (!setup.consistencyPercent || setup.consistencyPercent <= 0 || setup.consistencyPercent > 100) {
                    errors.consistencyPercent = translations[currentLang].invalidInput;
                }
                
                // Validate min trading days if enabled
                if (setup.minTradingDaysEnabled) {
                    if (!setup.minTradingDays || setup.minTradingDays < 1) {
                        errors['min-trading-days'] = translations[currentLang].requiredField;
                    }
                }
                
                return {
                    isValid: Object.keys(errors).length === 0,
                    errors
                };
            }
            
            static validateTrade(profit, loss, setup) {
                const errors = {};
                
                if (profit === 0 && loss === 0) {
                    errors.general = translations[currentLang].tradeNote;
                    return { isValid: false, errors };
                }
                
                if (profit > 0 && loss > 0) {
                    errors.general = translations[currentLang].tradeNote;
                    return { isValid: false, errors };
                }
                
                if (profit < 0 || loss < 0) {
                    errors.general = translations[currentLang].invalidInput;
                    return { isValid: false, errors };
                }
                
                return { isValid: true, errors: {} };
            }
        }

        // ========================================
        // DATE/TIME UTILITIES
        // ========================================
        class TradingDate {
            // Convert any date to Sydney timezone
            static getSydneyTime(date = new Date()) {
                return new Date(date.toLocaleString('en-US', { timeZone: SYDNEY_TIMEZONE }));
            }
            
            // Get trading day number (1=Monday, 7=Sunday in Sydney timezone)
            static getTradingDayNumber(date = new Date()) {
                const sydneyTime = this.getSydneyTime(date);
                const sydneyHour = sydneyTime.getHours();
                const sydneyDay = sydneyTime.getDay();
                
                // Convert Sunday (0) to 7 for easier calculations
                const dayOfWeek = sydneyDay === 0 ? 7 : sydneyDay;
                
                // If before Sydney Open (07:00), it's previous trading day
                if (sydneyHour < SYDNEY_OPEN_HOUR) {
                    return dayOfWeek === 1 ? 5 : dayOfWeek - 1; // Monday goes to Friday
                }
                
                return dayOfWeek;
            }
            
            // Get trading date string based on Sydney timezone
            // This ensures trading day follows Sydney open (07:00 AEDT/AEST)
            static getTradingDateStr(date = new Date()) {
                const sydneyTime = this.getSydneyTime(date);
                const sydneyHour = sydneyTime.getHours();
                const sydneyDate = sydneyTime.getDate();
                const sydneyMonth = sydneyTime.getMonth();
                const sydneyYear = sydneyTime.getFullYear();
                
                // If before Sydney Open (07:00), trading day is previous day
                if (sydneyHour < SYDNEY_OPEN_HOUR) {
                    const prevDate = new Date(sydneyYear, sydneyMonth, sydneyDate);
                    prevDate.setDate(prevDate.getDate() - 1);
                    return this.formatDate(prevDate);
                }
                
                return this.formatDate(sydneyTime);
            }
            
            // Get display date in user's local timezone
            static getLocalDateStr(date = new Date()) {
                const localDate = new Date(date.toLocaleString('en-US', { 
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone 
                }));
                return this.formatDate(localDate);
            }
            
            // Get local time string for display
            static getLocalTimeStr(date = new Date()) {
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${hours}:${minutes}`;
            }
            
            static formatDate(date) {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            }
            
            static getCurrentTimestamp() {
                return new Date().toLocaleString('id-ID', {
                    timeZone: SYDNEY_TIMEZONE,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
            
            // Get Sydney time formatted for display
            static getSydneyTimeStr(date = new Date()) {
                const sydneyTime = this.getSydneyTime(date);
                const day = String(sydneyTime.getDate()).padStart(2, '0');
                const month = String(sydneyTime.getMonth() + 1).padStart(2, '0');
                const hours = String(sydneyTime.getHours()).padStart(2, '0');
                const minutes = String(sydneyTime.getMinutes()).padStart(2, '0');
                return `${day}/${month} ${hours}:${minutes}`;
            }
        }

        // ========================================
        // MAIN APP CLASS
        // ========================================
        class ConsistCalc {
            constructor() {
                this.setup = this.loadSetup();
                this.trades = this.loadTrades();
                this.initializeForm();
                this.updateDisplay();
                this.setupEventListeners();
            }
            
            loadSetup() {
                try {
                    const saved = localStorage.getItem('consistcalc-setup');
                    if (!saved) {
                        return this.getDefaultSetup();
                    }
                    
                    const setup = JSON.parse(saved);
                    return {
                        ...this.getDefaultSetup(),
                        ...setup,
                        currencySymbol: this.getCurrencySymbol(setup.currency)
                    };
                } catch (error) {
                    console.error('Error loading setup:', error);
                    Toast.error(translations[currentLang].error);
                    return this.getDefaultSetup();
                }
            }
            
            getDefaultSetup() {
                return {
                    currency: 'USD',
                    currencySymbol: '$',
                    accountBalance: 0,
                    targetPercent: 0,
                    maxLossPercent: 0,
                    dailyLossPercent: 0,
                    riskTradingPercent: 0,
                    consistencyPercent: 0,
                    minTradingDaysEnabled: false,
                    minTradingDays: 0
                };
            }
            
            loadTrades() {
                try {
                    const saved = localStorage.getItem('consistcalc-trades');
                    return saved ? JSON.parse(saved) : [];
                } catch (error) {
                    console.error('Error loading trades:', error);
                    Toast.error(translations[currentLang].error);
                    return [];
                }
            }
            
            getCurrencySymbol(code) {
                const symbols = {
                    USD: '$', IDR: 'Rp', EUR: '€', GBP: '£', JPY: '¥',
                    CAD: 'C$', AUD: 'A$', CNY: '¥', SGD: 'S$', MYR: 'RM',
                    THB: '฿', KRW: '₩', INR: '₹', CHF: 'CHF', NZD: 'NZ$'
                };
                return symbols[code] || '$';
            }
            
            initializeForm() {
                // Set form values from loaded setup
                document.getElementById('currency').value = this.setup.currency;
                document.getElementById('account-balance').value = this.setup.accountBalance || '';
                document.getElementById('target-percent').value = this.setup.targetPercent || '';
                document.getElementById('max-loss-percent').value = this.setup.maxLossPercent || '';
                document.getElementById('daily-loss-percent').value = this.setup.dailyLossPercent || '';
                document.getElementById('risk-trading-percent').value = this.setup.riskTradingPercent || '';
                document.getElementById('consistency-percent').value = this.setup.consistencyPercent || '';
                document.getElementById('min-trading-days-enabled').checked = this.setup.minTradingDaysEnabled || false;
                document.getElementById('min-trading-days').value = this.setup.minTradingDays || '';
                
                // Update daily limit display
                this.updateDailyLimitDisplay();
            }
            
            setupEventListeners() {
                // Enter key for trade input
                document.getElementById('profit').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.addTrade();
                });
                
                document.getElementById('loss').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.addTrade();
                });
                
                // Real-time update for Max Daily Limit
                const accountBalanceInput = document.getElementById('account-balance');
                const targetPercentInput = document.getElementById('target-percent');
                const consistencyPercentInput = document.getElementById('consistency-percent');
                const currencySelect = document.getElementById('currency');
                
                if (accountBalanceInput) {
                    accountBalanceInput.addEventListener('input', () => this.updateDailyLimitDisplay());
                }
                
                if (targetPercentInput) {
                    targetPercentInput.addEventListener('input', () => this.updateDailyLimitDisplay());
                }
                
                if (consistencyPercentInput) {
                    consistencyPercentInput.addEventListener('input', () => this.updateDailyLimitDisplay());
                }
                
                if (currencySelect) {
                    currencySelect.addEventListener('change', () => {
                        this.updateCurrencySymbol();
                        this.updateDailyLimitDisplay();
                    });
                }
            }
            
            saveSetup() {
                const saveBtn = document.getElementById('save-setup-btn');
                const originalText = saveBtn.innerHTML;
                
                try {
                    // Show loading state
                    saveBtn.classList.add('btn-loading');
                    saveBtn.disabled = true;
                    
                    // Get values
                    const setup = {
                        currency: document.getElementById('currency').value,
                        currencySymbol: document.querySelector('#currency option:checked').getAttribute('data-symbol'),
                        accountBalance: parseFloat(document.getElementById('account-balance').value) || 0,
                        targetPercent: parseFloat(document.getElementById('target-percent').value) || 0,
                        maxLossPercent: parseFloat(document.getElementById('max-loss-percent').value) || 0,
                        dailyLossPercent: parseFloat(document.getElementById('daily-loss-percent').value) || 0,
                        riskTradingPercent: parseFloat(document.getElementById('risk-trading-percent').value) || 0,
                        consistencyPercent: parseFloat(document.getElementById('consistency-percent').value) || 0,
                        minTradingDaysEnabled: document.getElementById('min-trading-days-enabled').checked,
                        minTradingDays: parseInt(document.getElementById('min-trading-days').value) || 0
                    };
                    
                    // Validate
                    const validation = Validator.validateSetup(setup);
                    if (!validation.isValid) {
                        this.showValidationErrors(validation.errors);
                        throw new Error(translations[currentLang].invalidInput);
                    }
                    
                    // Save
                    this.setup = setup;
                    localStorage.setItem('consistcalc-setup', JSON.stringify(setup));
                    
                    // Update daily limit display
                    this.updateDailyLimitDisplay();
                    
                    // Update display
                    this.updateDisplay();
                    
                    // Collapse section
                    const content = document.getElementById('setup-content');
                    const toggle = document.getElementById('setup-toggle');
                    if (!content.classList.contains('collapsed')) {
                        content.classList.add('collapsed');
                        toggle.classList.add('collapsed');
                    }
                    
                    // Show motivational toast
                    const lang = localStorage.getItem('consistcalc-lang') || 'id';
                    Toast.success(translations[lang].msgSaveSetup);
                    
                } catch (error) {
                    console.error('Save setup error:', error);
                    Toast.error(error.message || translations[currentLang].error);
                } finally {
                    // Restore button
                    setTimeout(() => {
                        saveBtn.classList.remove('btn-loading');
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = originalText;
                    }, 500);
                }
            }
            
            showValidationErrors(errors) {
                // Clear previous errors
                document.querySelectorAll('.form-error').forEach(el => {
                    el.textContent = '';
                    el.style.display = 'none';
                });
                
                // Show new errors
                Object.entries(errors).forEach(([field, message]) => {
                    const errorEl = document.getElementById(`${field}-error`);
                    if (errorEl) {
                        errorEl.textContent = message;
                        errorEl.style.display = 'block';
                    }
                    
                    const input = document.getElementById(field);
                    if (input) {
                        input.classList.add('invalid');
                        input.focus();
                    }
                });
            }
            
            resetAll() {
                if (confirm(translations[currentLang].resetAllConfirm)) {
                    try {
                        localStorage.removeItem('consistcalc-setup');
                        localStorage.removeItem('consistcalc-trades');
                        
                        this.setup = this.getDefaultSetup();
                        this.trades = [];
                        
                        this.initializeForm();
                        this.updateDisplay();
                        
                        Toast.success(translations[currentLang].success);
                    } catch (error) {
                        console.error('Reset error:', error);
                        Toast.error(translations[currentLang].error);
                    }
                }
            }
            
            addTrade() {
                const addBtn = document.getElementById('add-trade-btn');
                const originalText = addBtn.innerHTML;
                
                try {
                    // Show loading state
                    addBtn.classList.add('btn-loading');
                    addBtn.disabled = true;
                    
                    // Get values
                    const profit = parseFloat(document.getElementById('profit').value) || 0;
                    const loss = parseFloat(document.getElementById('loss').value) || 0;
                    
                    // Validate
                    const validation = Validator.validateTrade(profit, loss, this.setup);
                    if (!validation.isValid) {
                        if (validation.errors.general) {
                            Toast.error(validation.errors.general);
                        }
                        throw new Error(translations[currentLang].invalidInput);
                    }
                    
                    // Check limits
                    const dailyLossLimit = (this.setup.dailyLossPercent / 100) * this.setup.accountBalance;
                    const totalLossLimit = (this.setup.maxLossPercent / 100) * this.setup.accountBalance;
                    const currentTotalLoss = this.trades.reduce((sum, t) => sum + (t.loss || 0), 0);
                    
                    if (loss > dailyLossLimit && this.setup.dailyLossPercent > 0) {
                        Toast.error(`${translations[currentLang].dailyLossExceeded} (${this.setup.currencySymbol}${dailyLossLimit.toFixed(2)})`);
                        throw new Error('Daily loss limit exceeded');
                    }
                    
                    if (currentTotalLoss + loss >= totalLossLimit && this.setup.maxLossPercent > 0) {
                        Toast.error(`${translations[currentLang].totalLossExceeded} (${this.setup.currencySymbol}${totalLossLimit.toFixed(2)})`);
                        throw new Error('Total loss limit exceeded');
                    }
                    
                    // Create trade
                    const trade = {
                        tradingDay: TradingDate.getTradingDayNumber(),
                        tradingDate: TradingDate.getTradingDateStr(),
                        profit: profit,
                        loss: loss,
                        timestamp: TradingDate.getCurrentTimestamp()
                    };
                    
                    // Add to array
                    this.trades.push(trade);
                    localStorage.setItem('consistcalc-trades', JSON.stringify(this.trades));
                    
                    // Clear inputs
                    document.getElementById('profit').value = '';
                    document.getElementById('loss').value = '';
                    
                    // Update display
                    this.updateDisplay();
                    
                    // Show motivational toast
                    const lang = localStorage.getItem('consistcalc-lang') || 'id';
                    Toast.success(translations[lang].msgTradeAdded);
                    
                } catch (error) {
                    console.error('Add trade error:', error);
                    // Error already shown via Toast
                } finally {
                    // Restore button
                    setTimeout(() => {
                        addBtn.classList.remove('btn-loading');
                        addBtn.disabled = false;
                        addBtn.innerHTML = originalText;
                    }, 500);
                }
            }
            
            deleteTrade(index) {
                if (confirm(translations[currentLang].deleteConfirm)) {
                    try {
                        this.trades.splice(index, 1);
                        localStorage.setItem('consistcalc-trades', JSON.stringify(this.trades));
                        this.updateDisplay();
                        Toast.success(translations[currentLang].success);
                    } catch (error) {
                        console.error('Delete trade error:', error);
                        Toast.error(translations[currentLang].error);
                    }
                }
            }
            
            calculateMaxDailyLimit() {
                const accountBalance = this.setup.accountBalance || 0;
                const targetPercent = this.setup.targetPercent || 0;
                const consistencyPercent = this.setup.consistencyPercent || 0;
                
                // Formula: (Consistency % / 100) × (Target % / 100) × Account Balance
                const maxDailyLimit = (consistencyPercent / 100) * (targetPercent / 100) * accountBalance;
                
                return maxDailyLimit;
            }
            
            updateDailyLimitDisplay() {
                // Get values from input fields for real-time calculation
                const accountBalance = parseFloat(document.getElementById('account-balance')?.value) || 0;
                const targetPercent = parseFloat(document.getElementById('target-percent')?.value) || 0;
                const consistencyPercent = parseFloat(document.getElementById('consistency-percent')?.value) || 0;
                const currencyOption = document.querySelector('#currency option:checked');
                const currencySymbol = currencyOption?.getAttribute('data-symbol') || (app?.setup?.currencySymbol) || '$';
                
                // If consistency rule is 0%, hide all consistency-related elements
                const hasConsistencyRule = consistencyPercent > 0;
                
                // Toggle visibility based on consistency rule
                const dbBox = document.getElementById('daily-limit-box');
                const statsCard = document.querySelector('.stat-card.daily-limit');
                const hintElement = document.getElementById('daily-limit-hint');
                
                if (dbBox) {
                    dbBox.style.display = hasConsistencyRule ? 'block' : 'none';
                }
                if (statsCard) {
                    statsCard.style.display = hasConsistencyRule ? 'block' : 'none';
                }
                if (hintElement) {
                    hintElement.style.display = hasConsistencyRule ? 'block' : 'none';
                }
                
                // If no consistency rule, stop here
                if (!hasConsistencyRule) {
                    return;
                }
                
                // Formula: (Consistency % / 100) × (Target % / 100) × Account Balance
                const maxDailyLimit = (consistencyPercent / 100) * (targetPercent / 100) * accountBalance;
                
                const sym = currencySymbol;
                const lang = localStorage.getItem('consistcalc-lang') || 'id';
                
                // Update Database section
                const dbElement = document.getElementById('daily-limit-value');
                if (dbElement) {
                    dbElement.textContent = formatCurrency(maxDailyLimit, sym);
                }
                
                // Update Statistics section - value
                const statElement = document.getElementById('daily-limit-stat');
                if (statElement) {
                    statElement.textContent = formatCurrency(maxDailyLimit, sym);
                }
                
                // Update Statistics section - status text
                const statusElement = document.getElementById('daily-limit-status');
                if (statusElement) {
                    const statusText = lang === 'id' 
                        ? 'Konsistensi aman jika profit ≤ batas' 
                        : 'Consistency safe if profit ≤ limit';
                    statusElement.textContent = statusText;
                }
                
                // Update Trading Input section
                if (hintElement) {
                    const prefix = lang === 'id' ? 'Batas aman hari ini: ' : 'Max safe today: ';
                    hintElement.textContent = prefix + formatCurrency(maxDailyLimit, sym);
                }
            }
            
            calculateStatistics() {
                const totalProfit = this.trades.reduce((sum, t) => sum + (t.profit || 0), 0);
                const totalLoss = this.trades.reduce((sum, t) => sum + (t.loss || 0), 0);
                const netProfit = totalProfit - totalLoss;
                
                // Group by trading date
                const dailyStats = {};
                this.trades.forEach(t => {
                    const date = t.tradingDate;
                    if (!dailyStats[date]) {
                        dailyStats[date] = {
                            profits: [],
                            losses: [],
                            openPos: 0
                        };
                    }
                    dailyStats[date].openPos += 1;
                    if (t.profit > 0) dailyStats[date].profits.push(t.profit);
                    if (t.loss > 0) dailyStats[date].losses.push(t.loss);
                });
                
                // Calculate max daily profit (highest single trade value, not sum)
                let maxDailyProfit = 0;
                this.trades.forEach(trade => {
                    if (trade.profit > maxDailyProfit) {
                        maxDailyProfit = trade.profit;
                    }
                });
                
                // Calculate metrics
                const totalBalance = this.setup.accountBalance + netProfit;
                const targetAmount = (this.setup.targetPercent / 100) * this.setup.accountBalance;
                const progressTarget = targetAmount > 0 ? (netProfit / targetAmount) * 100 : 0;
                
                let profitFactor;
                if (totalLoss > 0) {
                    profitFactor = (totalProfit / totalLoss).toFixed(2);
                } else if (totalProfit > 0) {
                    profitFactor = '∞';
                } else {
                    profitFactor = '-';
                }
                
                let consistencyRule, consistencyStatus;
                
                // Calculate total trading days
                const uniqueTradingDays = Object.keys(dailyStats).length;
                
                // Check minimum trading days requirement
                const minDaysEnabled = this.setup.minTradingDaysEnabled && this.setup.minTradingDays > 0;
                const minDaysMet = uniqueTradingDays >= this.setup.minTradingDays;
                const daysRemaining = Math.max(0, this.setup.minTradingDays - uniqueTradingDays);
                
                if (netProfit <= 0) {
                    consistencyRule = '-';
                    consistencyStatus = translations[currentLang].noProfit;
                } else {
                    // Always calculate consistency from day 1
                    const consistencyValue = (maxDailyProfit / netProfit) * 100;
                    const consistencyMet = consistencyValue <= this.setup.consistencyPercent;
                    
                    // Build status: include both consistency AND min days info
                    let statusText = '';
                    if (minDaysEnabled && !minDaysMet) {
                        // Show consistency result AND min days requirement
                        statusText = `${consistencyMet ? '✓' : '✗'} ${translations[currentLang].daysRemaining} ${daysRemaining}`;
                    } else {
                        statusText = consistencyMet 
                            ? '✓ ' + translations[currentLang].consistencyMet.split('!')[0] 
                            : '✗ ' + translations[currentLang].consistencyNotMet.split('!')[0];
                    }
                    
                    consistencyRule = consistencyValue.toFixed(2) + '%';
                    consistencyStatus = statusText;
                }
                
                // Check if minimum trading days requirement is met
                const minDaysRequirementMet = !minDaysEnabled || minDaysMet;
                
                const passedChallenge = (
                    progressTarget >= 100 && 
                    netProfit > 0 && 
                    minDaysRequirementMet &&
                    (parseFloat(consistencyRule) <= this.setup.consistencyPercent || consistencyRule === '-')
                );
                
                // NEW: Calculate risk metrics
                const riskLimit = (this.setup.riskTradingPercent / 100) * this.setup.accountBalance;
                const highRiskTrades = this.trades.filter(t => t.loss > riskLimit && this.setup.riskTradingPercent > 0);
                const highRiskCount = highRiskTrades.length;
                const highRiskTotalLoss = highRiskTrades.reduce((sum, t) => sum + t.loss, 0);
                
                // NEW: Calculate Daily Loss metrics (Fixed from opening balance, resets daily)
                const currentTradingDate = TradingDate.getTradingDateStr();
                const todayTrades = this.trades.filter(t => t.tradingDate === currentTradingDate);
                const todayLoss = todayTrades.reduce((sum, t) => sum + (t.loss || 0), 0);
                const dailyLossLimitAmount = (this.setup.dailyLossPercent / 100) * this.setup.accountBalance;
                const dailyLossUsedPercent = dailyLossLimitAmount > 0 ? (todayLoss / dailyLossLimitAmount) * 100 : 0;
                
                // NEW: Calculate Max Loss metrics (Floating from current balance)
                const totalLossForMax = this.trades.reduce((sum, t) => sum + (t.loss || 0), 0);
                const totalProfitForMax = this.trades.reduce((sum, t) => sum + (t.profit || 0), 0);
                const netProfitForMax = totalProfitForMax - totalLossForMax;
                const currentTotalBalance = this.setup.accountBalance + netProfitForMax;
                const maxLossLimitAmount = (this.setup.maxLossPercent / 100) * currentTotalBalance;
                const maxLossUsedPercent = maxLossLimitAmount > 0 ? (totalLossForMax / maxLossLimitAmount) * 100 : 0;
                
                return {
                    totalBalance,
                    totalProfit,
                    totalLoss,
                    netProfit,
                    progressTarget,
                    profitFactor,
                    consistencyRule,
                    consistencyStatus,
                    passedChallenge,
                    maxDailyProfit,
                    totalTrades: this.trades.length,
                    uniqueTradingDays,
                    dailyStats,
                    targetAmount,
                    maxDailyLimit: this.calculateMaxDailyLimit(),
                    // NEW: Risk metrics
                    riskLimit,
                    highRiskCount,
                    highRiskTotalLoss,
                    hasHighRiskTrades: highRiskCount > 0,
                    // Daily Loss metrics (Fixed, resets daily)
                    dailyLossLimitAmount,
                    dailyLossUsed: todayLoss,
                    dailyLossUsedPercent: Math.min(dailyLossUsedPercent, 100),
                    // Max Loss metrics (Floating)
                    maxLossLimitAmount,
                    maxLossUsed: totalLossForMax,
                    maxLossUsedPercent: Math.min(maxLossUsedPercent, 100),
                    // Min days tracking
                    minDaysEnabled,
                    minDaysMet,
                    daysRemaining
                };
            }
            
            updateDisplay() {
                const stats = this.calculateStatistics();
                const sym = this.setup.currencySymbol;
                
                // Update daily limit display
                this.updateDailyLimitDisplay();
                
                // Update statistics
                document.getElementById('total-balance').textContent = formatCurrency(stats.totalBalance, sym);
                document.getElementById('total-profit').textContent = formatCurrency(stats.totalProfit, sym);
                document.getElementById('total-loss').textContent = formatCurrency(stats.totalLoss, sym);
                document.getElementById('net-profit').textContent = formatCurrency(stats.netProfit, sym);
                document.getElementById('progress-target').textContent = stats.progressTarget.toFixed(1) + '%';
                document.getElementById('profit-factor').textContent = stats.profitFactor;
                document.getElementById('consistency-rule').textContent = stats.consistencyRule;
                document.getElementById('total-trading').textContent = stats.totalTrades;
                
                // Update Daily Loss Card (Fixed, resets daily)
                const dailyLossLimitStatEl = document.getElementById('daily-loss-limit-stat');
                const dailyLossSubinfoEl = document.getElementById('daily-loss-subinfo');
                const dailyLossProgressFillEl = document.getElementById('daily-loss-progress-fill');
                if (dailyLossLimitStatEl) {
                    dailyLossLimitStatEl.textContent = formatCurrency(stats.dailyLossLimitAmount, sym);
                }
                if (dailyLossSubinfoEl) {
                    const usedPercent = stats.dailyLossUsedPercent.toFixed(2);
                    dailyLossSubinfoEl.textContent = localStorage.getItem('consistcalc-lang') === 'en' 
                        ? `${usedPercent}% used` 
                        : `${usedPercent}% terpakai`;
                }
                if (dailyLossProgressFillEl) {
                    dailyLossProgressFillEl.style.width = Math.min(stats.dailyLossUsedPercent, 100) + '%';
                    dailyLossProgressFillEl.classList.remove('safe', 'warning', 'danger');
                    if (stats.dailyLossUsedPercent >= 100) {
                        dailyLossProgressFillEl.classList.add('danger');
                    } else if (stats.dailyLossUsedPercent >= 75) {
                        dailyLossProgressFillEl.classList.add('warning');
                    } else {
                        dailyLossProgressFillEl.classList.add('safe');
                    }
                }
                
                // Update Max Loss Card (Floating, follows balance)
                const maxLossLimitStatEl = document.getElementById('max-loss-limit-stat');
                const maxLossSubinfoEl = document.getElementById('max-loss-subinfo');
                const maxLossProgressFillEl = document.getElementById('max-loss-progress-fill');
                if (maxLossLimitStatEl) {
                    maxLossLimitStatEl.textContent = formatCurrency(stats.maxLossLimitAmount, sym);
                }
                if (maxLossSubinfoEl) {
                    const usedPercent = stats.maxLossUsedPercent.toFixed(2);
                    maxLossSubinfoEl.textContent = localStorage.getItem('consistcalc-lang') === 'en' 
                        ? `${usedPercent}% used` 
                        : `${usedPercent}% terpakai`;
                }
                if (maxLossProgressFillEl) {
                    maxLossProgressFillEl.style.width = Math.min(stats.maxLossUsedPercent, 100) + '%';
                    maxLossProgressFillEl.classList.remove('safe', 'warning', 'danger');
                    if (stats.maxLossUsedPercent >= 100) {
                        maxLossProgressFillEl.classList.add('danger');
                    } else if (stats.maxLossUsedPercent >= 75) {
                        maxLossProgressFillEl.classList.add('warning');
                    } else {
                        maxLossProgressFillEl.classList.add('safe');
                    }
                }
                
                document.getElementById('daily-limit-stat').textContent = formatCurrency(stats.maxDailyLimit, sym);
                
                // Apply styling classes
                this.applyStatStyling(stats);
                
                // Update motivational messages
                this.updateMotivationalMessages(stats);
                
                // Update trade history dengan RISK WARNING
                this.updateTradeHistory(stats);
                
                // Update alerts termasuk risk alerts
                this.updateAlerts(stats);
            }
            
            applyStatStyling(stats) {
                const netEl = document.getElementById('net-profit');
                netEl.className = stats.netProfit >= 0 ? 'stat-value profit' : 'stat-value loss';
                
                const progEl = document.getElementById('progress-target');
                progEl.className = stats.progressTarget >= 100 ? 'stat-value profit' : 'stat-value';
                
                const consistencyRuleEl = document.getElementById('consistency-rule');
                const consistencyValue = parseFloat(stats.consistencyRule);
                if (!isNaN(consistencyValue) && consistencyValue > 0) {
                    consistencyRuleEl.className = consistencyValue <= this.setup.consistencyPercent 
                        ? 'stat-value consistency-success' 
                        : 'stat-value consistency-fail';
                } else {
                    consistencyRuleEl.className = 'stat-value';
                }
                
                const profitFactorEl = document.getElementById('profit-factor');
                if (stats.profitFactor !== '-') {
                    if (stats.profitFactor === '∞') {
                        profitFactorEl.className = 'stat-value profit-factor-success';
                    } else {
                        const pfValue = parseFloat(stats.profitFactor);
                        profitFactorEl.className = pfValue > 1.5 ? 'stat-value profit-factor-success' : 'stat-value profit-factor-fail';
                    }
                } else {
                    profitFactorEl.className = 'stat-value';
                }
            }
            
            updateTradeHistory(stats) {
                const tbody = document.getElementById('history-tbody');
                
                if (this.trades.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="empty-state">
                                <div class="empty-state-icon">📊</div>
                                <div class="empty-state-title" data-i18n="noData">${translations[currentLang].noData}</div>
                                <div class="empty-state-description">${translations[currentLang].tradingSubtitle}</div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Group trades by date
                const tradesByDate = {};
                this.trades.forEach((t, i) => {
                    if (!tradesByDate[t.tradingDate]) {
                        tradesByDate[t.tradingDate] = [];
                    }
                    tradesByDate[t.tradingDate].push({ ...t, index: i, posInDay: tradesByDate[t.tradingDate].length + 1 });
                });
                
                // Build table rows dengan RISK WARNING
                const rows = [];
                Object.entries(tradesByDate).forEach(([dateStr, trades]) => {
                    const dailyNet = trades.reduce((sum, t) => sum + (t.profit - t.loss), 0);
                    const maxProfit = Math.max(...trades.map(t => t.profit));
                    const hasHighRiskInDay = trades.some(t => t.loss > stats.riskLimit && this.setup.riskTradingPercent > 0);
                    
                    // Add day separator row if there are high-risk trades
                    if (hasHighRiskInDay) {
                        rows.push(`
                            <tr class="day-risk-warning" colspan="7">
                                <td colspan="7">
                                    ⚠️ ${translations[currentLang].riskExceeded} ${this.setup.currencySymbol}${stats.riskLimit.toFixed(2)}
                                </td>
                            </tr>
                        `);
                    }
                    
                    trades.forEach((t, idx) => {
                        const isPeak = t.profit > 0 && t.profit === maxProfit;
                        const isHighRiskLoss = t.loss > stats.riskLimit && this.setup.riskTradingPercent > 0;
                        const dailyNetDisplay = idx === 0 
                            ? formatCurrency(dailyNet, this.setup.currencySymbol)
                            : '-';
                        
                        // Build loss cell dengan risk warning
                        let lossCell;
                        if (t.loss > 0) {
                            if (isHighRiskLoss) {
                                lossCell = `
                                    <td class="high-risk-loss risk-warning-cell">
                                        <div class="risk-warning-container">
                                            ${formatCurrency(t.loss, this.setup.currencySymbol)}
                                            <span class="risk-warning-icon" title="${translations[currentLang].riskWarningDesc}">!</span>
                                            <div class="risk-warning-tooltip">
                                                ${translations[currentLang].riskExceeded} ${this.setup.currencySymbol}${stats.riskLimit.toFixed(2)}
                                            </div>
                                        </div>
                                    </td>
                                `;
                            } else {
                                lossCell = `<td class="loss">${formatCurrency(t.loss, this.setup.currencySymbol)}</td>`;
                            }
                        } else {
                            lossCell = `<td>${formatCurrency(0, this.setup.currencySymbol)}</td>`;
                        }
                        
                        rows.push(`
                            <tr ${isHighRiskLoss ? 'class="risk-warning-cell"' : ''}>
                                <td>${idx === 0 ? dateStr : ''}</td>
                                <td>${t.posInDay}</td>
                                <td class="profit">${t.profit > 0 ? formatCurrency(t.profit, this.setup.currencySymbol) : formatCurrency(0, this.setup.currencySymbol)}</td>
                                ${lossCell}
                                <td class="${dailyNet >= 0 ? 'profit' : 'loss'}">${dailyNetDisplay}</td>
                                <td>${isPeak && t.profit > 0 ? '✓' : ''}</td>
                                <td>
                                    <button class="btn btn-danger" style="padding: 4px 8px; font-size: 0.7rem;" 
                                            onclick="app.deleteTrade(${t.index})"
                                            aria-label="${translations[currentLang].deleteConfirm}">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                        `);
                    });
                });
                
                tbody.innerHTML = rows.join('');
            }
            
            updateAlerts(stats) {
                const container = document.getElementById('alerts-container');
                container.innerHTML = '';
                
                const alerts = [];
                
                // Success alerts
                if (stats.passedChallenge) {
                    alerts.push({ type: 'success', msg: translations[currentLang].passedChallenge });
                }
                
                if (stats.progressTarget >= 100) {
                    alerts.push({ type: 'success', msg: translations[currentLang].targetAchieved });
                }
                
                if (stats.consistencyStatus.includes('✓')) {
                    alerts.push({ type: 'success', msg: translations[currentLang].consistencyMet });
                }
                
                // Warning alerts
                if (stats.consistencyStatus.includes('✗')) {
                    alerts.push({ type: 'warning', msg: translations[currentLang].consistencyNotMet });
                }
                
                // Minimum trading days alert
                if (stats.minDaysEnabled && !stats.minDaysMet) {
                    alerts.push({
                        type: 'info',
                        msg: `${translations[currentLang].minDaysNotMet} ${stats.daysRemaining} ${translations[currentLang].daysRemaining}`
                    });
                }
                
                if (stats.progressTarget > 0 && stats.progressTarget < 100) {
                    alerts.push({ 
                        type: 'info', 
                        msg: `${translations[currentLang].progressToTarget} ${stats.progressTarget.toFixed(1)}%`
                    });
                }
                
                // NEW: Risk alerts
                if (stats.hasHighRiskTrades) {
                    alerts.push({
                        type: 'risk',
                        msg: `${stats.highRiskCount} ${translations[currentLang].highRiskTrade.toLowerCase()}(s) detected! Total high-risk loss: ${formatCurrency(stats.highRiskTotalLoss, this.setup.currencySymbol)}`
                    });
                }
                
                // Create alert elements
                alerts.forEach(alert => {
                    const div = document.createElement('div');
                    div.className = `alert-banner ${alert.type}`;
                    div.setAttribute('role', 'alert');
                    div.innerHTML = `
                        <span>${alert.type === 'success' ? '✓' : alert.type === 'warning' ? '⚠️' : alert.type === 'risk' ? '⚠️' : 'ℹ️'}</span>
                        <span>${alert.msg}</span>
                    `;
                    container.appendChild(div);
                });
            }
            
            updateMotivationalMessages(stats) {
                const lang = localStorage.getItem('consistcalc-lang') || 'id';
                const t = translations[lang];
                const consistencyRule = this.setup.consistencyPercent || 0;
                
                // If consistency rule is 0%, hide all consistency-related elements
                const hasConsistencyRule = consistencyRule > 0;
                
                // Hide/show consistency elements based on rule
                const dbBox = document.getElementById('daily-limit-box');
                const statsCard = document.querySelector('.stat-card.daily-limit');
                const dbMsg = document.getElementById('db-motivational-msg');
                const statsMsg = document.getElementById('stats-motivational-msg');
                const statsStatus = document.getElementById('daily-limit-status');
                
                // Toggle visibility based on consistency rule
                if (dbBox) {
                    dbBox.style.display = hasConsistencyRule ? 'block' : 'none';
                }
                if (statsCard) {
                    statsCard.style.display = hasConsistencyRule ? 'block' : 'none';
                }
                
                // If no consistency rule, don't show messages
                if (!hasConsistencyRule) {
                    return;
                }
                
                // Determine consistency level and message
                let consistencyValue = 0;
                let isValidConsistency = false;
                let isTargetAchieved = stats.progressTarget >= 100 && stats.netProfit > 0;
                
                // Parse consistency value
                if (stats.consistencyRule !== '-' && stats.consistencyRule !== undefined) {
                    consistencyValue = parseFloat(stats.consistencyRule.replace('%', ''));
                    isValidConsistency = true;
                }
                
                // Determine message type and content
                let messageType = 'safe';
                let message = t.msgSafe;
                
                if (!isValidConsistency || stats.netProfit <= 0) {
                    // No profit yet or invalid consistency
                    messageType = 'info';
                    message = t.msgDayOne;
                } else if (isTargetAchieved) {
                    // Target achieved
                    messageType = 'milestone';
                    message = t.msgTargetAchieved;
                } else if (consistencyValue > consistencyRule) {
                    // Consistency exceeded
                    messageType = 'danger';
                    message = t.msgDanger;
                } else if (consistencyValue >= consistencyRule * 0.9) {
                    // Close to limit (within 10% of limit) - DYNAMIC based on input rule
                    messageType = 'warning';
                    message = t.msgWarning;
                } else {
                    // Safe
                    messageType = 'safe';
                    message = t.msgSafe;
                }
                
                // Update Database motivational message
                if (dbMsg) {
                    dbMsg.textContent = message;
                    dbMsg.className = `motivational-message ${messageType}`;
                }
                
                // Update Statistics motivational message
                if (statsMsg) {
                    // Shorten message for stat card
                    let shortMessage = message;
                    if (message.length > 50) {
                        shortMessage = message.substring(0, 50) + '...';
                    }
                    statsMsg.textContent = shortMessage;
                    statsMsg.className = `stat-card-message ${messageType}`;
                }
                
                // Update Statistics status text
                if (statsStatus) {
                    const statusText = lang === 'id' 
                        ? `Konsistensi aman jika profit ≤ ${formatCurrency(this.calculateMaxDailyLimit(), this.setup.currencySymbol)}`
                        : `Consistency safe if profit ≤ ${formatCurrency(this.calculateMaxDailyLimit(), this.setup.currencySymbol)}`;
                    statsStatus.textContent = statusText;
                }
                
                // Update History header message
                const historyMsg = document.getElementById('history-motivational-msg');
                if (historyMsg) {
                    if (this.trades.length === 0) {
                        historyMsg.textContent = t.msgDayOne;
                        historyMsg.className = 'history-header-message';
                    } else {
                        historyMsg.textContent = t.msgHistoryHeader;
                        historyMsg.className = 'history-header-message';
                    }
                }
            }
        }

        // ========================================
        // SERVICE WORKER REGISTRATION
        // ========================================
        
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('[App] Service Worker registered:', registration);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('[App] Service Worker update found:', newWorker);
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Show update notification
                                    showUpdateNotification();
                                }
                            });
                        });
                        
                        // Check if there's a waiting service worker
                        if (registration.waiting) {
                            showUpdateNotification();
                        }
                    })
                    .catch(error => {
                        console.error('[App] Service Worker registration failed:', error);
                    });
            });
        }

        // Function to show update notification
        function showUpdateNotification() {
            if (confirm('A new version of ConsistCalc is available. Update now?')) {
                // Send message to service worker to skip waiting
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        action: 'skipWaiting'
                    });
                    
                    // Wait a moment then reload
                    setTimeout(() => {
                        window.location.reload();
                    }, 100);
                }
            }
        }

        // ========================================
        // INITIALIZATION
        // ========================================
        let app;

        function initDarkMode() {
            const themeToggle = document.getElementById('dark-mode-switch');
            const themeText = document.getElementById('theme-text');
            const html = document.documentElement;
            
            // Load saved theme
            const savedTheme = localStorage.getItem('consistcalc-theme') || 'light';
            html.setAttribute('data-theme', savedTheme);
            
            if (savedTheme === 'dark') {
                themeToggle.checked = true;
                themeText.textContent = translations[currentLang].lightMode;
                document.getElementById('theme-toggle').setAttribute('aria-pressed', 'true');
            } else {
                themeText.textContent = translations[currentLang].darkMode;
                document.getElementById('theme-toggle').setAttribute('aria-pressed', 'false');
            }
            
            // Toggle theme
            themeToggle.addEventListener('change', function() {
                if (this.checked) {
                    html.setAttribute('data-theme', 'dark');
                    themeText.textContent = translations[currentLang].lightMode;
                    localStorage.setItem('consistcalc-theme', 'dark');
                    document.getElementById('theme-toggle').setAttribute('aria-pressed', 'true');
                } else {
                    html.setAttribute('data-theme', 'light');
                    themeText.textContent = translations[currentLang].darkMode;
                    localStorage.setItem('consistcalc-theme', 'light');
                    document.getElementById('theme-toggle').setAttribute('aria-pressed', 'false');
                }
            });
            
            // Add keyboard support for theme toggle
            document.getElementById('theme-toggle').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    themeToggle.click();
                }
            });
        }

        function switchLanguage(lang) {
            try {
                currentLang = lang;
                const t = translations[lang] || translations.id;
                
                // Update all translatable elements
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (t[key]) {
                        if (el.tagName === 'INPUT') {
                            el.value = t[key];
                        } else {
                            el.textContent = t[key];
                        }
                    }
                });
                
                // Update placeholders
                document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-i18n-placeholder');
                    if (t[key]) el.placeholder = t[key];
                });
                
                // Update language buttons
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    const isActive = btn.dataset.lang === lang;
                    btn.classList.toggle('active', isActive);
                    btn.setAttribute('aria-current', isActive ? 'true' : 'false');
                });
                
                // Update theme toggle text
                const themeText = document.getElementById('theme-text');
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                themeText.textContent = isDark ? t.lightMode : t.darkMode;
                
                // Save preference
                localStorage.setItem('consistcalc-lang', lang);
                document.documentElement.lang = lang;
                
                // Update app display
                if (app) app.updateDisplay();
                
            } catch (error) {
                console.error('Language switch error:', error);
            }
        }

        function toggleSection(contentId, toggleId) {
            const content = document.getElementById(contentId);
            const toggle = document.getElementById(toggleId);
            const isCollapsed = content.classList.contains('collapsed');
            
            content.classList.toggle('collapsed');
            toggle.classList.toggle('collapsed');
            toggle.setAttribute('aria-expanded', !isCollapsed);
            
            // Update header aria-expanded
            const header = toggle.closest('.section-header');
            if (header) {
                header.setAttribute('aria-expanded', !isCollapsed);
            }
        }

        function updateCurrencySymbol() {
            if (!app) return;
            const select = document.getElementById('currency');
            const symbol = select.options[select.selectedIndex].getAttribute('data-symbol');
            app.setup.currencySymbol = symbol;
            app.updateDisplay();
        }

        function handleTradeKeyPress(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                app.addTrade();
            }
        }

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Initialize dark mode
                initDarkMode();
                
                // Initialize language
                const savedLang = localStorage.getItem('consistcalc-lang') || 'id';
                switchLanguage(savedLang);
                
                // Language buttons
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    btn.addEventListener('click', () => switchLanguage(btn.dataset.lang));
                    btn.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            switchLanguage(btn.dataset.lang);
                        }
                    });
                });
                
                // Initialize app
                app = new ConsistCalc();

                // Add keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    // Ctrl+S to save setup
                    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                        e.preventDefault();
                        app.saveSetup();
                    }
                    
                    // Ctrl+Enter to add trade
                    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                        e.preventDefault();
                        const activeElement = document.activeElement;
                        if (activeElement.id === 'profit' || activeElement.id === 'loss') {
                            app.addTrade();
                        }
                    }
                });
                
                // Show welcome message
                setTimeout(() => {
                    Toast.info('Welcome to ConsistCalc! Start by configuring your trading parameters.');
                }, 1000);
                
            } catch (error) {
                console.error('Initialization error:', error);
                Toast.error('Failed to initialize application. Please refresh the page.');
            }
        });

        // ========================================
        // PROFESSIONAL PDF REPORT GENERATION
        // ========================================
        
        // Helper function to convert image to base64
        function imageToBase64(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.onerror = reject;
                img.src = url;
            });
        }
        
        async function generatePDFReport() {
            if (!app || app.trades.length === 0) {
                Toast.warning('No trading data to export');
                return;
            }

            try {
                showLoading(true, 'Generating PDF Report...');
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 15;
                let yPos = margin;
                const stats = app.calculateStatistics();
                const sym = app.setup.currencySymbol;

                // Colors - Updated to match analyzed PDF
                const primaryColor = [99, 102, 242]; // Header background, section underlines
                const tableHeaderColor = [98, 102, 240]; // Table header background
                const textColor = [17, 23, 39]; // Main text
                const lightGray = [156, 162, 174]; // Labels and secondary text
                const successColor = [16, 184, 129]; // Profit values, success indicators
                const dangerColor = [238, 68, 68]; // Loss values
                const bgLight = [247, 249, 252]; // Card and row backgrounds
                const whiteColor = [255, 255, 255]; // White text

                // ===============================
                // HEADER / KOP SURAT
                // ===============================
                // Header background
                doc.setFillColor(...primaryColor);
                doc.rect(0, 0, pageWidth, 35, 'F');
                
                // Logo icon - convert to base64 for PDF
                try {
                    const iconBase64 = await imageToBase64('icon-192x192.png');
                    doc.addImage(iconBase64, 'PNG', margin, 5.5, 24, 24);
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(28);
                    doc.setFont('helvetica', 'bold');
                    doc.text('ConsistCalc', margin + 30, 20);
                    
                    // Subtitle
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Trading Discipline and Growth Tracker', margin + 30, 28);
                } catch (iconError) {
                    // Fallback if icon fails to load - white text on colored background
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(28);
                    doc.setFont('helvetica', 'bold');
                    doc.text('ConsistCalc', margin, 20);
                    
                    // Subtitle
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Trading Discipline and Growth Tracker', margin, 28);
                }
                
                // Date generated
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text(`Generated: ${new Date().toLocaleString('id-ID', { 
                    day: '2-digit', month: 'long', year: 'numeric', 
                    hour: '2-digit', minute: '2-digit' 
                })}`, pageWidth - margin, 25, { align: 'right' });
                
                yPos = 45;

                // ===============================
                // SECTION: STATISTICAL RESULTS
                // ===============================
                doc.setTextColor(...primaryColor);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('STATISTICAL RESULTS', margin, yPos);
                
                // Underline
                doc.setDrawColor(...primaryColor);
                doc.setLineWidth(0.5);
                doc.line(margin, yPos + 2, pageWidth - margin, yPos + 2);
                
                yPos += 10;

                // Stats grid
                const statsData = [
                    ['Total Balance', formatCurrency(stats.totalBalance, sym)],
                    ['Total Profit', formatCurrency(stats.totalProfit, sym)],
                    ['Total Loss', formatCurrency(stats.totalLoss, sym)],
                    ['Net Profit', formatCurrency(stats.netProfit, sym)],
                    ['Progress Target', stats.progressTarget.toFixed(2) + '%'],
                    ['Profit Factor', stats.profitFactor],
                    ['Consistency', stats.consistencyRule],
                    ['Status', stats.consistencyStatus.replace('✓ ', '').replace('✗ ', '')],
                    ['Total Trading', stats.totalTrades.toString()]
                ];

                const boxWidth = (pageWidth - margin * 2 - 8) / 3;
                const boxHeight = 18;
                
                statsData.forEach((item, index) => {
                    const col = index % 3;
                    const row = Math.floor(index / 3);
                    const boxX = margin + col * (boxWidth + 4);
                    const boxY = yPos + row * (boxHeight + 4);
                    
                    // Box background
                    doc.setFillColor(...bgLight);
                    doc.roundedRect(boxX, boxY, boxWidth, boxHeight, 3, 3, 'F');
                    
                    // Label - Menggunakan hitam sesuai permintaan
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text(item[0], boxX + 4, boxY + 6);
                    
                    // Value - Menggunakan hitam, loss tetap merah
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    
                    // Color based on value type - Loss tetap merah
                    if (item[0] === 'Net Profit' || item[0] === 'Total Profit') {
                        const val = parseFloat(item[1].replace(/[^-\d.]/g, ''));
                        if (val < 0) doc.setTextColor(...dangerColor);
                    }
                    if (item[0] === 'Status') {
                        if (item[1].includes('met') || item[1].includes('BERHASIL')) doc.setTextColor(0, 0, 0);
                        else doc.setTextColor(...dangerColor);
                    }
                    
                    doc.text(item[1], boxX + 4, boxY + 13);
                });

                yPos += Math.ceil(statsData.length / 3) * (boxHeight + 4) + 10;

                // ===============================
                // SECTION: TRADING HISTORY
                // ===============================
                // Check if we need a new page
                if (yPos > pageHeight - 80) {
                    doc.addPage();
                    yPos = margin;
                }

                doc.setTextColor(...primaryColor);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('TRADING HISTORY', margin, yPos);
                
                // Underline
                doc.setDrawColor(...primaryColor);
                doc.setLineWidth(0.5);
                doc.line(margin, yPos + 2, pageWidth - margin, yPos + 2);
                
                yPos += 8;

                // Table header
                doc.setFillColor(...tableHeaderColor);
                doc.rect(margin, yPos, pageWidth - margin * 2, 8, 'F');
                
                doc.setTextColor(...whiteColor);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                
                const colWidths = [30, 20, 35, 35, 35, 25];
                const headers = ['Date', '#', 'Profit', 'Loss', 'Daily Net', 'Peak'];
                let xPos = margin + 2;
                
                headers.forEach((header, i) => {
                    doc.text(header, xPos, yPos + 5.5);
                    xPos += colWidths[i];
                });
                
                yPos += 8;

                // Table body
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                
                // Group trades by date
                const tradesByDate = {};
                app.trades.forEach((t, i) => {
                    if (!tradesByDate[t.tradingDate]) {
                        tradesByDate[t.tradingDate] = [];
                    }
                    tradesByDate[t.tradingDate].push({ ...t, index: i });
                });

                let rowCount = 0;
                Object.entries(tradesByDate).forEach(([dateStr, trades]) => {
                    const dailyNet = trades.reduce((sum, t) => sum + (t.profit - t.loss), 0);
                    const maxProfit = Math.max(...trades.map(t => t.profit));
                    
                    trades.forEach((t, idx) => {
                        // Check if we need a new page
                        if (yPos > pageHeight - 20) {
                            doc.addPage();
                            yPos = margin;
                            
                            // Repeat header
                            doc.setFillColor(99, 102, 241);
                            doc.rect(margin, yPos, pageWidth - margin * 2, 8, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(9);
                            doc.setFont('helvetica', 'bold');
                            xPos = margin + 2;
                            headers.forEach((header, i) => {
                                doc.text(header, xPos, yPos + 5.5);
                                xPos += colWidths[i];
                            });
                            yPos += 8;
                            doc.setFont('helvetica', 'normal');
                        }
                        
                        // Alternating row colors
                        if (rowCount % 2 === 0) {
                            doc.setFillColor(248, 250, 252);
                            doc.rect(margin, yPos, pageWidth - margin * 2, 7, 'F');
                        }
                        
                        xPos = margin + 2;
                        
                        // Date - Menggunakan hitam
                        doc.setTextColor(0, 0, 0);
                        doc.text(dateStr, xPos, yPos + 5);
                        xPos += colWidths[0];
                        
                        // Position - Menggunakan hitam
                        doc.setTextColor(0, 0, 0);
                        doc.text((idx + 1).toString(), xPos, yPos + 5);
                        xPos += colWidths[1];
                        
                        // Profit - Menggunakan hitam (bukan hijau)
                        if (t.profit > 0) {
                            doc.setTextColor(0, 0, 0);
                            doc.text('+' + formatCurrency(t.profit, sym), xPos, yPos + 5);
                        } else {
                            doc.setTextColor(0, 0, 0);
                            doc.text(formatCurrency(0, sym), xPos, yPos + 5);
                        }
                        xPos += colWidths[2];
                        
                        // Loss - Menggunakan merah (tetap)
                        if (t.loss > 0) {
                            doc.setTextColor(...dangerColor);
                            doc.text('-' + formatCurrency(t.loss, sym), xPos, yPos + 5);
                        } else {
                            doc.setTextColor(0, 0, 0);
                            doc.text(formatCurrency(0, sym), xPos, yPos + 5);
                        }
                        xPos += colWidths[3];
                        
                        // Daily Net (only for first trade of day) - Hitam, loss harian tetap merah
                        doc.setTextColor(0, 0, 0);
                        if (idx === 0) {
                            if (dailyNet < 0) doc.setTextColor(...dangerColor);
                            doc.text((dailyNet >= 0 ? '+' : '') + formatCurrency(dailyNet, sym), xPos, yPos + 5);
                        }
                        xPos += colWidths[4];
                        
                        // Peak indicator - Menggunakan hitam (bukan hijau)
                        doc.setTextColor(0, 0, 0);
                        if (t.profit > 0 && t.profit === maxProfit) {
                            doc.setTextColor(0, 0, 0);
                            doc.text('✓ PEAK', xPos, yPos + 5);
                        } else {
                            doc.text('-', xPos, yPos + 5);
                        }
                        
                        yPos += 7;
                        rowCount++;
                    });
                });

                // ===============================
                // FOOTER
                // ===============================
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFillColor(...bgLight);
                    doc.rect(0, pageHeight - 12, pageWidth, 12, 'F');
                    
                    doc.setTextColor(...lightGray);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    
                    // Page number on left
                    doc.text(`Page ${i} of ${totalPages}`, margin, pageHeight - 4.5, { align: 'left' });
                    
                    // App branding on right
                    doc.text('Generated by ConsistCalc', pageWidth - margin, pageHeight - 4.5, { align: 'right' });
                }

                // Download PDF
                const fileName = `ConsistCalc_Report_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                Toast.success('PDF Report downloaded successfully!');
                
            } catch (error) {
                console.error('PDF Generation Error:', error);
                Toast.error('Failed to generate PDF. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        // Make functions globally available
        window.saveSetup = () => app.saveSetup();
        window.resetAll = () => app.resetAll();
        window.addTrade = () => app.addTrade();
        window.handleTradeKeyPress = handleTradeKeyPress;
        window.updateCurrencySymbol = updateCurrencySymbol;
        window.toggleSection = toggleSection;
        window.generatePDFReport = generatePDFReport;
        window.app = app;
    </script>
</body>
</html>